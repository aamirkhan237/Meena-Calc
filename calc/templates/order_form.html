<!DOCTYPE html>
<html>
<head>
    <title>Product Order Form</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .order-row {
            display: flex;
            align-items: center;
        }
        .order-row .form-group {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <form method="post" id="orderForm">
            {% csrf_token %}
            <div id="orders-container">
                <div class="order-row">
                    <div class="form-group">
                        <label for="product">Select a product:</label>
                        <select name="product[]" class="form-control">
                            <option value="">Select a Product</option>
                            {% for product in products %}
                                <option value="{{ product.id }}">{{ product.name }} - ${{ product.price_per_gram }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="grams">Grams required:</label>
                        <input type="number" name="grams[]" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" name="quantity[]" value="1" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="discount">Discount (%):</label>
                        <input type="number" name="discount[]" value="0" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="price">Price:</label>
                        <input type="text" name="price[]" class="form-control" readonly>
                    </div>
                </div>
            </div>

            <button type="button" id="add-order" class="btn btn-primary">+ Add Order</button>
            <button type="button" id="process-order" class="btn btn-success">Process Order</button>
        </form>

        <!-- Table to display current orders -->
        <h2>Current Orders</h2>
        <table id="current-orders" class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Grams</th>
                    <th>Quantity</th>
                    <th>Discount (%)</th>
                    <th>Price</th>
                </tr>
            </thead>
             <tbody id="order-details">
                </tbody>
            <tfoot>
                <tr>
                    <td colspan="4"><strong>Total Price:</strong></td>
                    <td><span id="total-price">0.00</span></td>
                </tr>
            </tfoot>
        </table>

        <!-- Bootstrap JS and jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
            $(document).ready(function() {
                function calculateRowPrice(row) {
                    // Retrieve values from the current row
                    var grams = parseFloat($(row).find('input[name="grams[]"]').val()) || 0;
                    var quantity = parseInt($(row).find('input[name="quantity[]"]').val()) || 1;
                    var discount = parseFloat($(row).find('input[name="discount[]"]').val()) || 0;
                    var pricePerGram = parseFloat($(row).find('select[name="product[]"]').find(':selected').text().split('$')[1]);
                
                    // Calculate the row price
                    var rowPrice = pricePerGram * grams * quantity * (1 - discount / 100);
                    $(row).find('input[name="price[]"]').val(rowPrice.toFixed(2));
                }

                // Add order button functionality
                $('#add-order').on('click', function() {
                    // Clone the first order row and append it to the orders container
                    var newRow = $('.order-row:first').clone();
                    $('#orders-container').append(newRow);
                
                    // Clear values in the new row
                    newRow.find('input').val('');
                    newRow.find('select').val('');
                });

                // Process order button functionality
                $('#process-order').on('click', function() {
                    var total = 0;
                    $('#current-orders tbody').empty(); // Clear previous table rows
                
                    // Iterate through each order row
                    $('.order-row').each(function() {
                        var row = $(this);
                        calculateRowPrice(row); // Calculate row price
                        var rowPrice = parseFloat(row.find('input[name="price[]"]').val()) || 0;
                        total += rowPrice; // Add row price to total
                
                        // Retrieve order details
                        var product = row.find('select[name="product[]"]').find(':selected').text().split(' - ')[0];
                        var grams = row.find('input[name="grams[]"]').val();
                        var quantity = row.find('input[name="quantity[]"]').val();
                        var discount = row.find('input[name="discount[]"]').val();
                
                        // Append order details to the table
                        $('#current-orders tbody').append('<tr>' +
                            '<td>' + product + '</td>' +
                            '<td>' + grams + '</td>' +
                            '<td>' + quantity + '</td>' +
                            '<td>' + discount + '</td>' +
                            '<td>' + rowPrice.toFixed(2) + '</td>' +
                            '</tr>');
                    });
                
                    // Display the total price
                    $('#total-price').text(total.toFixed(2));
                });
                
            });
        </script>
    </div>
</body>
</html>
