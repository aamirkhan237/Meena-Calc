{% load static %}

<!DOCTYPE html>
<html>

<head>
    <title>Product Order Form</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&family=Salsa&display=swap" rel="stylesheet">

    <style>
        .custom-bg-color {
            background-color: lightgreen;
            color: black;
        }

        body {
            background-color: #f5f5f5;
            /* Light gray background */
        }

        .order-row {
            display: flex;
            align-items: center;
        }

        .order-row .form-group {
            margin-right: 10px;
        }

        .custom-navbar-bg {
            background-color: #f4ce5b;
        }

        /* Position the delete button icon */
        .delete-icon {
            width: 30px;
            /* Set width as needed */
            height: 25px;
            /* Set height as needed */
            cursor: pointer;
            /* Set cursor as pointer for interaction */
            margin-left: 10px;
            /* Adjust margin as needed for spacing */
            margin-top: 25px;
        }

        .align-items-center {
            justify-content: center;
            align-items: center;
            margin-left: 350px;
        }

        p {
            margin-top: 9px;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar bg custom-navbar-bg" style="padding-top: 5px; padding-bottom: 5px;">
        <div class="container">
            <a class="navbar-brand" href="https://www.meenafragrances.com/" target="_blank">
                <div class="row align-items-center">
                    <div class="col-12 col-lg-auto">
                        <img src="{% static 'images/meenalogo.png' %}" alt="Logo" width="130" height="auto">
                    </div>
                    <div class="col-12 col-lg-auto pl-lg-3">
                        <div style="color: #a23c37; font-family: 'Kaushan Script', cursive;">
                            <p>All fragrances, All time</p>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <form method="post" id="orderForm">
            {% csrf_token %}
            <div id="orders-container">
                <div class="order-row">
                    <div class="form-group">
                        <label for="product">Select a product:</label>

                        <select name="product[]" class="form-control select-product" id="products">
                            <option value="">Select a Product</option>
                            {% for product in products %}
                            <option class="option" value="{{ product.id }}">{{ product.name }} -
                                &#8377; {{product.price_per_gram }}</option>
                            {% endfor %}
                        </select>

                    </div>

                    <div class="form-group">
                        <label for="grams">Grams required:</label>
                        <input type="number" name="grams[]" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity:</label>
                        <input type="number" name="quantity[]" value="1" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="discount">Discount (%):</label>
                        <input type="number" name="discount[]" value="0" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="price">Price:</label>
                        <input type="text" name="price[]" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <img src="{% static 'images/delete_logo.png' %}" alt="Delete" class="delete-icon">
                    </div>
                </div>
            </div>

            <button type="button" id="add-order" class="btn btn-primary">+ Add Order</button>
            <button type="button" id="process-order" class="btn btn-success">Process Order</button>
        </form>

        <!-- Table to display current orders -->
        <h2>Current Orders</h2>
        <table id="current-orders" class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Grams</th>
                    <th>Quantity</th>
                    <th>Discount (%)</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody id="order-details">
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="4"><strong>Total Price:</strong></td>
                    <td><span id="total-price">0.00</span></td>

                </tr>

            </tfoot>

        </table>
        <div class="row">
            <div class="col">
                <label for="discount-current-order">Discount (%)</label>
                <input type="number" id="discount-current-order" class="form-control " value="0">
            </div>
            <div class="col">
                <label for="final-price">Final Price</label>
                <input type="text" id="final-price" class="form-control final-price-color .custom-bg-color">
            </div>
        </div>

        <div class="container">
            <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
                <div class="col-md-4 d-flex align-items-center">
                    <a href="/" class="mb-3 me-2 mb-md-0 text-muted text-decoration-none lh-1">
                        <svg class="bi" width="30" height="24">
                            <use xlink:href="#bootstrap"></use>
                        </svg>
                    </a>
                    <span class="text-muted">© Meena Company, Inc</span>
                </div>

                <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
                    <li class="ms-3"><a class="text-muted" href="#"><svg class="bi" width="24" height="24">
                                <use xlink:href="#twitter"></use>
                            </svg></a></li>
                    <li class="ms-3"><a class="text-muted" href="#"><svg class="bi" width="24" height="24">
                                <use xlink:href="#instagram"></use>
                            </svg></a></li>
                    <li class="ms-3"><a class="text-muted" href="#"><svg class="bi" width="24" height="24">
                                <use xlink:href="#facebook"></use>
                            </svg></a></li>
                </ul>
            </footer>
        </div>
        <!-- Bootstrap JS and jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
            $(document).ready(function () {

                $('.select-box').on('click', function () {
                    $(this).toggleClass('open');
                });

                $('.option').on('click', function () {
                    var selectedValue = $(this).text();
                    $('.select-box').removeClass('open');
                    $('.select-box').text(selectedValue);
                });

                // Filter options based on user input
                $('.select-box').on('input', function () {
                    var searchValue = $(this).text().toLowerCase();

                    $('.option').each(function () {
                        var optionText = $(this).text().toLowerCase();
                        $(this).toggle(optionText.indexOf(searchValue) > -1);
                    });
                    $(this).addClass('open');
                    $(this).text(searchValue);
                });

                function calculateRowPrice(row) {
                    var grams = parseFloat($(row).find('input[name="grams[]"]').val()) || 0;
                    var quantity = parseInt($(row).find('input[name="quantity[]"]').val()) || 1;
                    var discount = parseFloat($(row).find('input[name="discount[]"]').val()) || 0;
                    if (discount < 0) {
                        discount = 0; // Set discount to 0 if it's negative
                        parseFloat($(row).find('input[name="discount[]"]').val('0')); // Set the input field value to 0
                    }
                    var pricePerGram = parseFloat($(row).find('select[name="product[]"]').find(':selected').text().split('₹')[1]);

                    $(row).find('select[name="product[]"], input[name="grams[]"]').on('change', function () {
                        quantityInput.val('1');
                    });
                    // Calculate the row price
                    var rowPrice = pricePerGram * grams * quantity * (1 - discount / 100);
                    $(row).find('input[name="price[]"]').val(rowPrice.toFixed(2));
                }
                $(document).on('input', '.order-row input[name="grams[]"], .order-row input[name="quantity[]"], .order-row input[name="discount[]"]', function () {
                    var row = $(this).closest('.order-row');
                    calculateRowPrice(row);
                })
                $(document).on('click', '.delete-icon', function () {
                    $(this).closest('.order-row').remove();
                    // After deleting, recalculate prices or perform any necessary updates
                });



                function addOrderRow() {
                    var newRow = $('.order-row:first').clone();
                    $('#orders-container').append(newRow);

                    // Set default values to the new row
                    newRow.find('input[name="quantity[]"]').val('1');
                    newRow.find('input[name="discount[]"]').val('0');

                    // Clear other values in the new row
                    newRow.find('input[name="grams[]"], input[name="price[]"]').val('');
                    newRow.find('select[name="product[]"]').val('');

                    // Calculate row price for the new row immediately after adding
                    calculateRowPrice(newRow);
                }

                // Add order button functionality
                $('#add-order').on('click', function () {
                    addOrderRow();
                });

                calculateRowPrice($('.order-row:first'));

                // Process order button functionality
                $('#process-order').on('click', function () {
                    var total = 0;
                    $('#current-orders tbody').empty(); // Clear previous table rows

                    // Iterate through each order row
                    $('.order-row').each(function () {
                        $('#discount-current-order').trigger('input');
                        var row = $(this);
                        calculateRowPrice(row); // Calculate row price
                        var rowPrice = parseFloat(row.find('input[name="price[]"]').val()) || 0;
                        total += rowPrice; // Add row price to total

                        // Retrieve order details
                        var product = row.find('select[name="product[]"]').find(':selected').text().split(' - ')[0];
                        var grams = row.find('input[name="grams[]"]').val();
                        var quantity = row.find('input[name="quantity[]"]').val();
                        var discount = row.find('input[name="discount[]"]').val();

                        // Append order details to the table
                        $('#current-orders tbody').append('<tr>' +
                            '<td>' + product + '</td>' +
                            '<td>' + grams + '</td>' +
                            '<td>' + quantity + '</td>' +
                            '<td>' + discount + '</td>' +
                            '<td>' + rowPrice.toFixed(2) + '</td>' +
                            '</tr>');
                    });

                    // Display the total price
                    $('#total-price').text(total.toFixed(2));
                });
                $('#discount-current-order').on('input', function () {
                    var discountValue = parseFloat($(this).val()) || 0;
                    if (discountValue < 0) {
                        discountValue = 0; // Set discount to 0 if it's negative
                        $(this).val('0'); // Set the input field value to 0
                    }
                    var totalPrice = parseFloat($('#total-price').text()) || 0;

                    // Calculate final price after applying the discount
                    var finalPrice = totalPrice * (1 - discountValue / 100);

                    // Update the UI with the final price
                    $('#final-price').val(finalPrice.toFixed(2));
                    if (discountValue > 0) {
                        $('#final-price').addClass('custom-bg-color');
                    } else {
                        $('#final-price').removeClass('custom-bg-color');
                    }
                });

            });
        </script>


    </div>
</body>

</html>